# Interval-wise interpretation

enlever le t, t' et garder t, t+1 page 12 de l'article Sonya notation
$OR_{x\mid z}(\beta_{..}$ ou $OR_{x\mid z}(\beta_{g.})$

pas d'anova ici, mais test de Student sur les log odds ratios
(différences de clr), et tests de Student simultanément dans chaque
région (ajustés)

## Global trend

We focus on subintervals $I \subset (a,b)$ and wish to make assessments
about the time evolution of the relative probability to be in one
interval versus the other.

We can rely on Maier et al. (2024), see pages 10 and 11, proposition
3.1, for the definition of the infinitesimal odds-ratios and their
interpretation. The objective is to compare two densities at two
different temperatures $x$ and $z$ in the range of temperature. let
$\operatorname{OR}^{x\mid z}_{t\mid t'}$ be
$$\operatorname{OR}^{x\mid z}_{t\mid t'} =
 \frac{\frac{\pi_{it}(x)}{\pi_{it}(z)}}{\frac{\pi_{it'}(x)}{\pi_{it'} (z)}}
 = \frac{\pi_{it}(x) \ominus \pi_{it'}(x)}{\pi_{it}(z) \ominus \pi_{it'}(z)}$$
$\operatorname{OR}^{x\mid z}_{t\mid t'}$ allows to compare the density
at time $t$ and $t'$ as follows. It is an odds ratio: the ratio of the
odds of $x$ versus $z$ at time $t$ by the odds of $x$ versus $z$ at time
$t'$. In the model
[\[eq:slopereg\]](#eq:slopereg){reference-type="eqref"
reference="eq:slopereg"}, assuming $\epsilon_{git}=0$, we have that
$$\operatorname{OR}^{x\mid z}_{t\mid t'} = (\frac{\beta_{gi} (x)}{\beta_{gi} (z)})^{(t-t')}$$
which is linked to the rate of change of the odds of $x$ versus $z$ in
the period $(t',t).$ Because the probability of an event is an
increasing function of its odds, if we observe that
$\operatorname{OR}^{x\mid z}_{t\mid t'} >1$ for all $x,z$ when $x$ is in
a given interval $A$ and $z$ in a given interval $B,$ then we may
conclude that conditional on the temperature being in $A$ or $B$, the
probability of being closer to $x$ than to $z$ at time $t$ is larger
than the probability of being close to $x$ than to $z$ at time $t'.$
Note that when $t>t'$ $\operatorname{OR}^{x\mid z}_{t\mid t'} >1$ is
equivalent to $\beta_{gi}(x) > \beta_{gi}(z)$.

### Application: global change in temperature distribution over the period 1987-2016

```{r fig-interval_global}
#| fig-cap: Global trend.
#| fig-height: 3

fmin <- function(...) UseMethod("fmin")
fmax <- function(...) UseMethod("fmax")
fargmin <- function(...) UseMethod("fargmin")
fargmax <- function(...) UseMethod("fargmax")

fmin.fdl <- function(...) fmin(c(...))
fmax.fdl <- function(...) fmax(c(...))
fargmin.fdl <- function(...) fargmin(c(...))
fargmax.fdl <- function(...) fargmax(c(...))

fsolve <- function(...) UseMethod("fsolve")
fsolve.fdl <- function(...) fargmax(c(...))

fmin.fd <- function(fdobj,
                    a = min(fdobj$basis$rangeval),
                    b = max(fdobj$basis$rangeval)) {
  f <- function(x) eval(fdobj, x)
  results <- lapply(
    seq_along(f(a)),
    function(i) optimize(function(x) f(x)[i], interval = c(a, b))
  )
  sapply(results, `[[`, "objective")
}

fargmin.fd <- function(fdobj,
                       a = min(fdobj$basis$rangeval),
                       b = max(fdobj$basis$rangeval)) {
  f <- function(x) eval(fdobj, x)
  results <- lapply(
    seq_along(f(a)),
    function(i) optimize(function(x) f(x)[i], interval = c(a, b))
  )
  sapply(results, `[[`, "minimum")
}

fmax.fd <- function(fdobj,
                    a = min(fdobj$basis$rangeval),
                    b = max(fdobj$basis$rangeval)) {
  f <- function(x) -eval(fdobj, x)
  results <- lapply(
    seq_along(f(a)),
    function(i) optimize(function(x) f(x)[i], interval = c(a, b))
  )
  -sapply(results, `[[`, "objective")
}

fargmax.fd <- function(fdobj,
                       a = min(fdobj$basis$rangeval),
                       b = max(fdobj$basis$rangeval)) {
  f <- function(x) -eval(fdobj, x)
  results <- lapply(
    seq_along(f(a)),
    function(i) optimize(function(x) f(x)[i], interval = c(a, b))
  )
  sapply(results, `[[`, "minimum")
}

fsolve.fd <- function(fdobj, k,
                      a = min(fdobj$basis$rangeval),
                      b = max(fdobj$basis$rangeval)) {
  f <- function(x) eval(fdobj, x) - k
  results <- lapply(
    seq_along(f(a)),
    function(i) uniroot(function(x) f(x)[i], interval = c(a, b))
  )
  sapply(results, `[[`, "root")
}

thres0 <- 0.5 * (fmax(vnt_mean, 25, 30) + fmin(vnt_mean, 20, 25))

vnt_mean_thresholds <- tibble(
  x = c(
    fsolve(vnt_mean, fmax(vnt_mean, 25, 30), 15, 20),
    fsolve(vnt_mean, thres0, 15, 22),
    fsolve(vnt_mean, thres0, 22, 30),
    fsolve(vnt_mean, thres0, 30, 35),
    fsolve(vnt_mean, fmin(vnt_mean, 20, 25), 30, 35)
  ),
  y = c(
    fmax(vnt_mean, 25, 30),
    thres0,
    thres0,
    thres0,
    fmin(vnt_mean, 20, 25)
  )
)

vnt_mean_thresholds |> signif(3)

plot(vnt_mean) +
  geom_vline(data = vnt_mean_thresholds, aes(xintercept = x, color = y, linetype = -y)) +
  geom_hline(data = vnt_mean_thresholds, aes(yintercept = y, color = y, linetype = -y)) +
  scale_linetype_binned() +
  scale_y_continuous(n.breaks = 4) +
  theme(legend.position = "none") +
  labs(
    x = "Temperature (deg. Celsius)",
    y = "Density"
  )
```


## Regional trends

### Application: regional changes in temperature distribution over the period 1987-2016

```{r fig-interval_mountains}
#| fig-cap: Mountainous regions.
#| fig-height: 10
thres1 <- 0.5 * (fmax(vntr$t_max[[1]], 30, 35) + fmin(vntr$t_max[[1]], 20, 30))
thres3 <- 0.5 * (fmax(vntr$t_max[[3]], 30, 35) + fmin(vntr$t_max[[3]], 20, 30))

vnt_mountains_thresholds <- rbind(tibble(
  region = "NMM",
  x = c(
    fsolve(vntr$t_max[[1]], fmax(vntr$t_max[[1]], 30, 35), 20, 25),
    fsolve(vntr$t_max[[1]], thres1, 20, 25),
    fsolve(vntr$t_max[[1]], thres1, 25, 30),
    fsolve(vntr$t_max[[1]], thres1, 30, 35),
    fsolve(vntr$t_max[[1]], fmin(vntr$t_max[[1]], 20, 30), 30, 35)
  ),
  y = c(
    fmax(vntr$t_max[[1]], 30, 35),
    thres1,
    thres1,
    thres1,
    fmin(vntr$t_max[[1]], 20, 30)
  )
), tibble(
  region = "NCC",
  x = c(
    fsolve(vntr$t_max[[3]], fmax(vntr$t_max[[3]], 30, 35), 15, 25),
    fsolve(vntr$t_max[[3]], thres3, 20, 25),
    fsolve(vntr$t_max[[3]], thres3, 25, 30),
    fsolve(vntr$t_max[[3]], thres3, 30, 35),
    fsolve(vntr$t_max[[3]], fmin(vntr$t_max[[3]], 25, 30), 30, 35)
  ),
  y = c(
    fmax(vntr$t_max[[3]], 30, 35),
    thres3,
    thres3,
    thres3,
    fmin(vntr$t_max[[3]], 25, 30)
  )
))

vnt_mountains_thresholds |> mutate(x = signif(x, 3), y = signif(y, 3))

vntr |>
  filter(region %in% c("NMM", "NCC")) |>
  plot_funs(t_max) +
  geom_vline(data = vnt_mountains_thresholds, aes(xintercept = x, color = y, linetype = -y)) +
  geom_hline(data = vnt_mountains_thresholds, aes(yintercept = y, color = y, linetype = -y)) +
  facet_grid(vars(region), axes = "all") +
  scale_linetype_binned() +
  scale_y_continuous(n.breaks = 4) +
  theme(legend.position = "none") +
  labs(
    x = "Temperature (deg. Celsius)",
    y = "Density"
  )
```

```{r fig-interval_rrd}
#| fig-cap: The particular case of the Red River delta.
#| fig-height: 3
vnt_rrd_thresholds <- rbind(tibble(
  region = "RRD",
  x = c(
    fsolve(vntr$t_max[[2]], fmax(vntr$t_max[[2]], 12, 15), 35, 37),
    fsolve(vntr$t_max[[2]], fmax(vntr$t_max[[2]], 12, 15), 37, 40),
    fsolve(vntr$t_max[[2]], fmin(vntr$t_max[[2]], 37, 40), 15, 20),
    fsolve(vntr$t_max[[2]], fmin(vntr$t_max[[2]], 37, 40), 30, 35)
  ),
  y = c(
    fmax(vntr$t_max[[2]], 12, 15),
    fmax(vntr$t_max[[2]], 12, 15),
    fmin(vntr$t_max[[2]], 37, 40),
    fmin(vntr$t_max[[2]], 37, 40)
  )
), tibble(
  region = "CHR",
  x = c(
    fsolve(vntr$t_max[[4]], fmax(vntr$t_max[[4]], 20, 30), 35, 40),
    fsolve(vntr$t_max[[4]], fmin(vntr$t_max[[4]], 30, 40), 15, 20),
    fsolve(vntr$t_max[[4]], fmin(vntr$t_max[[4]], 30, 40), 20, 25)
  ),
  y = c(
    fmax(vntr$t_max[[4]], 20, 30),
    fmin(vntr$t_max[[4]], 30, 40),
    fmin(vntr$t_max[[4]], 30, 40)
  )
))

vnt_rrd_thresholds |> mutate(x = signif(x, 3), y = signif(y, 3))

vntr |>
  filter(region %in% c("RRD", "CHR")) |>
  plot_funs(t_max) +
  geom_vline(data = vnt_rrd_thresholds, aes(xintercept = x, color = y, linetype = -y)) +
  geom_hline(data = vnt_rrd_thresholds, aes(yintercept = y, color = y, linetype = -y)) +
  facet_grid(vars(region), axes = "all") +
  scale_linetype_binned() +
  scale_y_continuous(n.breaks = 4) +
  theme(legend.position = "none") +
  labs(
    x = "Temperature (deg. Celsius)",
    y = "Density"
  )
```

```{r fig-interval_south}
#| fig-cap: Southern regions.
#| fig-height: 7
vnt_south_thresholds <- rbind(tibble(
  region = "SR",
  x = c(
    fsolve(vntr$t_max[[5]], fmax(vntr$t_max[[5]], 12, 20), 20, 25),
    fsolve(vntr$t_max[[5]], fmax(vntr$t_max[[5]], 12, 20), 25, 30),
    fsolve(vntr$t_max[[5]], fmin(vntr$t_max[[5]], 12, 25), 30, 35)
  ),
  y = c(
    fmax(vntr$t_max[[5]], 12, 20),
    fmax(vntr$t_max[[5]], 12, 20),
    fmin(vntr$t_max[[5]], 12, 25)
  )
), tibble(
  region = "MDR",
  x = c(
    fsolve(vntr$t_max[[6]], fmax(vntr$t_max[[6]], 12, 20), 25, 30),
    fsolve(vntr$t_max[[6]], fmax(vntr$t_max[[6]], 12, 20), 30, 35),
    fsolve(vntr$t_max[[6]], fmin(vntr$t_max[[6]], 12, 25), 30, 35)
  ),
  y = c(
    fmax(vntr$t_max[[6]], 12, 20),
    fmax(vntr$t_max[[6]], 12, 20),
    fmin(vntr$t_max[[6]], 12, 25)
  )
))

vnt_south_thresholds |> mutate(x = signif(x, 3), y = signif(y, 3))

vntr |>
  filter(region %in% c("SR", "MDR")) |>
  plot_funs(t_max) +
  geom_vline(data = vnt_south_thresholds, aes(xintercept = x, color = y, linetype = -y)) +
  geom_hline(data = vnt_south_thresholds, aes(yintercept = y, color = y, linetype = -y)) +
  facet_grid(vars(region), axes = "all") +
  scale_linetype_binned() +
  scale_y_continuous(n.breaks = 4) +
  theme(legend.position = "none") +
  labs(
    x = "Temperature (deg. Celsius)",
    y = "Density"
  )
```
